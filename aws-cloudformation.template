{
    "Metadata" : {
        "Comment" : [
            "AWS CloudFormation template to create a collaborate instance",
            "",
            "Getting a list of allowed instance types programatically is an open cloudformation issue",
            "https://github.com/aws-cloudformation/cloudformation-coverage-roadmap/issues/425"
        ]
    },
    "Parameters": {
        "KeyName": {
            "Description": "Name of an existing EC2 key pair to enable SSH access to the instance.",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "AMIId": {
            "Description": "Name of a Parameter Store parameter that stores the ID of the Amazon Machine Image (AMI).",
            "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
            "Default": "/aws/service/canonical/ubuntu/server/focal/stable/current/amd64/hvm/ebs-gp2/ami-id"
        },
        "InstanceType": {
            "Type" : "String",
            "Default" : "m5.large",
            "AllowedValues" : ["t2.micro", "m1.small", "m1.large", "m5.large", "m5.2xlarge"]
        }
    },
    "Resources": {
        "InstanceSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable SSH access via port 22",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "Ec2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "KeyName": { "Ref": "KeyName" },
                "ImageId": { "Ref": "AMIId" },
                "InstanceType" : { "Ref": "InstanceType" },
                "SecurityGroups": [ { "Ref": "InstanceSecurityGroup" } ],
                "UserData" : { "Fn::Base64" : { "Fn::Join" : [ "\n", [
                    "#cloud-config",
                    "apt:",
                    "  sources:",
                    "    freesoft:",
                    "      source: \"deb http://www.freesoft.org/focal-270 bigbluebutton-focal main\"",
                    "      key: |",
                    "          -----BEGIN PGP PUBLIC KEY BLOCK-----",
                    "",
                    "          mQGNBF/NiYMBDAC9pM6L6qHbB08GfHCwveRKV43YUIjVE2k6X2it1FJskket2Bgd",
                    "          YmdgWuFFNjuJQM43OYigE5kM2AT8ENlkqteaTh63ahkYhBEOw25FFF9to/D8Aa6W",
                    "          O4vooQLxXCFDOx3RMsNdfzp4pMUCQAWqu9Qy53DdlY48aEa34FkIPVM+JSsh5r0X",
                    "          wBcRD6izHzsQbBiRMguhaI1IWh+6Yq+f+Pzh72UHERd9u6e2kPpcvYQTF2JVzI1V",
                    "          Wa9mCNU0YhHyhmQ21QW6/kWAia03WLmXlMpF5D7VfoFCPUXpCom8G9c77Ru9ny/W",
                    "          E/6TTSRKmBl3nK/EZUc9MAQ4Ao+UtqmuoEgWWmkLPCvB81d3K+Vwla/s7KPL7fYw",
                    "          V8DF5nGV4/vJhrXrLtqMvwPlDpO0nXmXCnrav/vqNpxZlF1W1Yf4qVgZDTa0wve1",
                    "          07LJp/3eUIv6Mr4V46JicL0ByPtNHch89ebl/yFNmVs4rcsYODDmaTJmp/50ZAqX",
                    "          J9ooohlaw1LCqFkAEQEAAbQjQnJlbnQgQmFjY2FsYSA8Y29zaW5lQGZyZWVzb2Z0",
                    "          Lm9yZz6JAc4EEwEKADgCGwMFCwkIBwIGFQoJCAsCBBYCAwECHgECF4AWIQSy6XhU",
                    "          osVXd2hD6wYmPFejYVyZGAUCZjF7PwAKCRAmPFejYVyZGOXRDACxj+8RmG02N4NJ",
                    "          JM5wMhk19KrBfrsKr+GbVNEXEzGlAmFlJGVvjvLu/7GGif5Nzu2y3IZaEHrg5zxw",
                    "          6+ZlvaafU+IaThVl8HIUvSPC0/FcOrroDnI8Blut/GsobLjkwB5/LTFGVPerronA",
                    "          ensiWsbROaOwLZscou2CjgPHU9c59WtFogvBKcHn6kKSY61YedduE6IUKDUkDGS3",
                    "          5xN7UNLUKyd2our958vAh+xsB+V+Hk0GjX2J2QTJvYEW8jc58G5xLCqdLlVA+cMt",
                    "          2nDlxUBzuVRI/g8PfSWC0afIIHYHd4v0/OJx8+qpWM41FfzhDMUyq56eSijeYoLB",
                    "          Qa7/mpNlAwIKli+alkTq87SDVTDE7LyBMmyTvA3wYRK0K0kgQ0G0GS4h0GypOz2f",
                    "          yufgF4LL1s48mkUSIgbp1fThoakw9y1/qF0xGEOMHFh3m2bycpCbsVv53DePOkYH",
                    "          uDhCq8K/qEvA3dSeMIxWvfTKLoFf2Rs76ZccWWWdRoDjU+Rq7Ua5AY0EX82JgwEM",
                    "          AKAbb9ySW5AYJoFUhVy5BmdD8ks2uSdAOLgkqVzQGC1MdxhWlOrwscLuO5Oogkv3",
                    "          qbfHJwTid5GWxh9OxeZUkVjqbl2AmJ3GE8Y242KpuN8srUcc/ZR4JpBLizR929MW",
                    "          z0D19inSPSuNMX9N0Ab6x+veT2Li/F3zv4VTxHWkC//ohvaFtAuf3f0fK/yC9eEa",
                    "          +x7WimPoNERGXZpVLH6NScCiSHN6J3M/K/toOp4Cdo+11sy6yAM4yFbAJjUMiClY",
                    "          sJoP4HQ/QAJMCXOmzF4BTjW6Zqrl8Xt9Yu9boQRdwZliLBWMXKS5uvYUHNGl8eky",
                    "          yVGJcteHLd3Y2tEsZyGuXzx4uzQzTmOIVuUyUKtcJbDJ9aAko9cdyMAZDWyK8s6g",
                    "          WaK/A6lMCyvHoTrO348guPKMJF6atMh6fp/nL3hrEH1qQ+V+6N7JnGzLHE4T8uLR",
                    "          XliFrOxasojsPVBrvSp8iUWUVT5pQ50hVZjT5Ny7xiF2V/tLZpb7NuWqVfPMwDsF",
                    "          ewARAQABiQG2BBgBCgAgAhsMFiEEsul4VKLFV3doQ+sGJjxXo2FcmRgFAmYxezUA",
                    "          CgkQJjxXo2FcmRhneQv/T75ZsBOxMjsdZzzG7PVAXu0Olt9vUapvaR310Z2tNLhT",
                    "          NwwmQvgPCXaUdloX+16dirIaoRqz0czh2Lh/y/+4XesIeuswwlmBMRgoQgfuyOdi",
                    "          qOYGhc6O219bXNu8yKxQaNLdWIoJmxlJeL+qMWdlA62/Q8tIe2tEzuCCHkcUZRFo",
                    "          dvhS4W/XclJFEyjpH6GbrIU5DqgyZ9ZiHYariLhUvwu2fsYIyOK5oMZWAnsKqDE1",
                    "          8MzPRNvUUCj2HDVCWiVH3Rcs44X5BIul0a2vZu0dB7kCtgplFtfne/cwRU2EHd3P",
                    "          zxqosEQNa5Oe8GDSULoqRB9QIlq1L5+/pT4gPofdpsH76te1Lpu8aDseRTa78dBD",
                    "          WKtGWZ7tAaNok/vliOe6uNY9QCtEV7K5Vc1vUWxI0M47wZNe+wgZhfeWmXEo8IVg",
                    "          v0b6NEkrZVcZ6Imp+F/4V4kGHnt+fTmB/ehijDTS0QBk0V7L9sMcD4cN7A55JVko",
                    "          xSaf+J344fYU8toyWlAY",
                    "          =ESw6",
                    "          -----END PGP PUBLIC KEY BLOCK-----",
                    "packages:",
                    "  - nsupdate-aws",
                    "  - ddclient",
                    "  - awscli",
                    "write_files:",
                    "  - path: /var/lib/cloud/scripts/per-once/configure-ddclient",
                    "    content: |",
                    "      #!/bin/sh",
                    "      cat > /etc/default/ddclient <<EOF",
                    "      export AWS_ACCESS_KEY_ID=AKIAY662P6OVROZ5W5MP",
                    "      export AWS_SECRET_ACCESS_KEY=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",
                    "      run_daemon=\"true\"",
                    "      EOF",
                    "      chmod 0400 /etc/default/ddclient",
                    "      systemctl enable ddclient",
                    "      systemctl stop ddclient",
                    "      systemctl start ddclient",
                    "    owner: 'root:root'",
                    "    permissions: '0755'",
                    "  - path: /etc/ddclient.conf",
                    "    content: |",
                    "      use=cmd",
                    "      cmd=\"/usr/bin/wget -qO- http://169.254.169.254/latest/meta-data/public-ipv4\"",
                    "      protocol=nsupdate",
                    "      login=/usr/share/nsupdate-aws/nsupdate-aws",
                    "      password=Z08462181NK07JJAPHM5M",
                    "      ttl=10",
                    "      qJw3FsJuSn4IACSJ5nmW.freesoft.org",
                    "    owner: 'root:root'",
                    "    permissions: '0400'",
                    ""
                ] ] } }
            }
        }
    },
    "Outputs": {
        "InstanceId": {
            "Value": { "Ref": "Ec2Instance" }
        },
        "IPAddress": {
            "Value": { "Fn::GetAtt": [ "Ec2Instance", "PublicIp" ] }
        }
    }
}
